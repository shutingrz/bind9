#!/bin/sh

top_builddir=@abs_top_builddir@

if [ -z "$1" ]; then
    echo "fatal: test name required"
    echo "Usage: $0 test_program"
    exit 1
fi

TEST_PROGRAM="$1"
shift

"$@" "$TEST_PROGRAM" &
pid="$!"
echo "Running $TEST_PROGRAM (PID=$pid)"
wait "$pid"
status=$?

test_program_name=$(basename "$TEST_PROGRAM")
test_program_work_dir=$(dirname "$TEST_PROGRAM")
core_dump="$(find "$test_program_work_dir" -name "core" -or -name "core.$pid" -or -name "$pid.core" | sed 's|\./||' | sort)"
find "$test_program_work_dir" -name 'core*'
if [ -n "$core_dump" ]; then
    binary=$(gdb --batch --core="$core_dump" 2>/dev/null | sed -ne "s/Core was generated by \`\(.*\)'./\1/p")
    if echo "$binary" | grep "$test_program_name$"; then
        echo "I:$test_program_name:There is a core dump after the test run: $core_dump"
        echo "D:$test_program_name:backtrace from $core_dump start"
        "$top_builddir/libtool" --mode=execute gdb \
                                  --batch \
                                  --command="$top_builddir/bin/tests/system/run.gdb" \
                                  --core="$core_dump" \
                                  -- \
                                  "$binary"
        echo "D:$test_program_name:backtrace from $core_dump end"
    fi
fi

exit $status
